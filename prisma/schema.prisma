// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Catégories de livres
model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  image       String?
  metaTitle   String?
  metaDescription String? @db.Text
  books       Book[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
}

// Livres
model Book {
  id               String      @id @default(cuid())
  title            String
  slug             String      @unique
  author           String?
  summary          String?     @db.Text
  description      String      @db.LongText
  price            Decimal     @db.Decimal(10, 2)
  originalPrice    Decimal?    @db.Decimal(10, 2)
  stock            Int         @default(0)
  images           String      @db.Text // JSON array of image URLs
  categoryId       String
  category         Category    @relation(fields: [categoryId], references: [id])
  featured         Boolean     @default(false)
  bestseller       Boolean     @default(false)
  metaTitle        String?
  metaDescription  String?     @db.Text
  orderItems       OrderItem[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@index([slug])
  @@index([categoryId])
  @@index([featured])
  @@index([bestseller])
}

// Statuts de commande
enum OrderStatus {
  PENDING
  PROCESSING
  DELIVERED
  CANCELLED
}

// Commandes
model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  customerName    String
  customerEmail   String?
  customerPhone   String
  shippingCity    String
  shippingArea    String
  shippingAddress String      @db.Text
  observations    String?     @db.Text
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @db.Decimal(10, 2)
  items           OrderItem[]
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

// Articles de commande
model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  bookId    String
  book      Book     @relation(fields: [bookId], references: [id])
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([bookId])
}

// Articles de blog
model BlogPost {
  id               String   @id @default(cuid())
  title            String
  slug             String   @unique
  excerpt          String?  @db.Text
  content          String   @db.LongText
  coverImage       String?
  author           String   @default("Royal Editions")
  published        Boolean  @default(false)
  metaTitle        String?
  metaDescription  String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([slug])
  @@index([published])
  @@index([createdAt])
}

// Témoignages
model Testimonial {
  id        String   @id @default(cuid())
  name      String
  role      String?
  content   String   @db.Text
  rating    Int      @default(5)
  image     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
}

// Conversations de chat
model ChatConversation {
  id            String        @id @default(cuid())
  visitorId     String        @unique // ID unique du visiteur
  visitorName   String?
  visitorEmail  String?
  status        String        @default("open") // open, closed
  lastMessageAt DateTime      @default(now())
  messages      ChatMessage[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([status])
  @@index([lastMessageAt])
}

// Messages de chat
model ChatMessage {
  id             String           @id @default(cuid())
  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         String           // "visitor" ou "admin"
  senderName     String           @default("Visiteur")
  text           String           @db.Text
  read           Boolean          @default(false)
  createdAt      DateTime         @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// Pages légales
model LegalPage {
  id        String   @id @default(cuid())
  slug      String   @unique // "cgv" ou "confidentialite"
  title     String
  content   String   @db.LongText
  published Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([published])
}

// Codes promotionnels
model PromoCode {
  id            String   @id @default(cuid())
  code          String   @unique // Code unique (ex: "ROYAL2024")
  description   String?  @db.Text
  discountType  String   // "percentage" ou "fixed"
  discountValue Decimal  @db.Decimal(10, 2) // Pourcentage (ex: 10 pour 10%) ou montant fixe
  minAmount     Decimal? @db.Decimal(10, 2) // Montant minimum de commande
  maxUses       Int?     // Nombre maximum d'utilisations (null = illimité)
  usedCount     Int      @default(0) // Nombre d'utilisations
  active        Boolean  @default(true)
  expiresAt     DateTime? // Date d'expiration (null = pas d'expiration)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([code])
  @@index([active])
  @@index([expiresAt])
}
